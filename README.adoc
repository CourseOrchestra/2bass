= 2BASS

image::https://ci.corchestra.ru/buildStatus/icon?job=2bass/dev[link=https://ci.corchestra.ru/job/2bass/job/dev/] image:https://api.codacy.com/project/badge/Grade/f26a1fbeb3f341f39594d16ede78d7b9["Codacy code quality", link="https://www.codacy.com/app/CourseOrchestra/2bass?utm_source=github.com&utm_medium=referral&utm_content=CourseOrchestra/2bass&utm_campaign=Badge_Grade"]

2bass is a database configuration-as-code tool that utilizes concept of https://dzone.com/articles/trouble-free-database-migration-idempotence-and-co[idempotent DDL scripts].

This is a derivative of link:https://github.com/CourseOrchestra/celesta[Celesta project], in particular, it uses link:https://corchestra.ru/wiki/index.php?title=%D0%AF%D0%B7%D1%8B%D0%BA_Celesta-SQL[CelestaSQL] as database definition language. Documentation for CelestaSQL is currently in Russian only, but syntax diagrams for the language are self-explanatory.

image::images/bass_duke.png[,200]

== Current status

This project is in development phase. No binaries released yet, see <<How to build>> to obtain a binary. If you want to contribute (suggestions/feature requests are very welcome!) please feel free to contact any of the contributors.

== How to build

You will need JDK 8 and Maven in order to build 2bass. If you want to run tests during the build, you will also need Docker to be installed. To build without running the tests, run


 mvn package -Dmaven.test.skip=true


The result of the build will be `target/2bass-<VERSION>-bin.zip` file.

== How to install

Prerequisites: JRE 8. Unzip `target/2bass-<VERSION>-bin.zip` file and make `bin` folder availiable on system path.
Run `bass` command and check its output.

== How to use
* Usage example is available at https://github.com/inponomarev/2bass-demo.

* Write and modify your database schema using CelestaSQL, which is in fact the plain old DDL.
Ð•. g. you may use CREATE TABLE for table definition, and then simply add/modify columns in the script when you need it,
no 'ALTER' commands in schema definition script. You may also use `EXEC NATIVE` blocks when you need to insert
database-specific code. See our https://github.com/inponomarev/2bass-demo[demo project] and https://corchestra.ru/wiki/index.php?title=%D0%AF%D0%B7%D1%8B%D0%BA_Celesta-SQL[wiki page] (in Russian, but with nice diagrams) about CelestaSQL.

* Edit bass.properties file.

* Use the following commands to operate:

** *bass init* -- to initialize system `bass` schema in your database:

** *bass apply* -- sync your actual DB structure with the desired structure described in your SQL files.
All the ALTER commands are calculated and executed automatically. You may run `apply` without running `init` previously:

** *bass plan* -- does not sync structure, print planned ALTER script for review / manual exectution.

image::images/3_update_success.png[,600]
image::images/2_plan.png[,800]

=== If something goes wrong during database migration

Sometimes bass is not able to perform the migration fully automatically. In this case will see the following:

image::images/3_update_failure.png[,800]

and for further details you should look at the contents of the `bass.schemas` table. In `message`
field you will see the error that prevented the automatic migration. The meaning of numbers in `state` column is
as following:

* **0** -- schema created/migrated successfully, will not attempt to migrate unless the checksum of DDL script is changed.
* **1** -- schema is currently in process of migration.
* **2** -- migration error (see `message` column for details).
* **3** -- force migration, regardless of DDL script checksum. In case of success the status will become **0**.
* **4** -- never migrate this schema, regardless of DDL script changes.

Normally in case of errors you should:

1. Write and execute an ad hoc migration script.
2. Change schema status to 3.
3. Re-run `bass apply`.
